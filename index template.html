<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
  <meta name="description" content="">
  <meta name="author" content="">
  <link rel="icon" href="../../favicon.ico">
<!-- Bootstrap CSS -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

  <title>Simple HTML Page with Bootstrap and Mapbox</title>

  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

  <style>
    #map {
      height: 600px;
    }
  </style>

</head>

<body>

  <!-- Container -->
  <div class="container">

    <!-- Masthead -->
    <div class="masthead">

      <!-- Navigation -->
      <nav>
      </nav>
    </div>

    <!-- Jumbotron -->
    <div class="jumbotron">
      <h1>Simple HTML Page</h1>
      <p class="lead">Working with Mapbox</p>
    </div>

    <!-- Main Content-->
    <div class="masthead">
      <h3 class="text-muted">Map</h3>
      <div class="row">
        <div class="col-md-12">
          <div id="map"></div>
        </div>
      </div>
    </div>

    <!-- Site footer -->
    <footer class="footer">
      <p>&copy; 2015 &ndash; <span id="currentYear">THIS YEAR</span></p>
    </footer>

<!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>    
  
  </div>
  <!-- /container -->
  <script>
    $(document).ready(init);

    function init(jQuery) {
      CurrentYear();

      initMap();
    }

    function CurrentYear() {
      var thisYear = new Date().getFullYear()
      $("#currentYear").text(thisYear);
    }


    // Map via Mapbox

    var mapCoordinates = [42.885441, -78.878464];
    var mapZoom = 11;

    var mapAccessToken = "";

    var mapUseLiveData = false;

    var map = null;
    var geocoder = null;

    var featureLayer = null;
    var currentLocationMarker = null;

    function Map() {
      L.mapbox.accessToken = mapAccessToken;

      // initialize map
      var newMap = L.mapbox.map("map", "mapbox.streets");

      newMap.setView(mapCoordinates, mapZoom);

      // geocoding
      geocoder = L.mapbox.geocoderControl("mapbox.places", {
        keepOpen: false,
        autocomplete: true
      });

      // geocoder event handlers
      geocoder.on("found", geocoderFoundResults);

      newMap.addControl(geocoder);

      // event handlers
      newMap.on("ready", mapReady);
      newMap.on("locationfound", mapLocationFound);
      newMap.on("locationerror", mapLocationError);

      return newMap;
    }

    function initMap() {
      map = Map();
    }

    function getCurrentLocation() {
      if (navigator.geolocation) {
        console.log("getting current location...");
        map.locate();
      }
    }


    // Mapbox

    function geocoderFoundResults(res) {
      console.log("geocoder found results...");
    }

    function initFeatureLayer() {
      featureLayer = L.mapbox.featureLayer().addTo(map);

      // layer event handlers
      featureLayer.on("ready", featureLayerReady);
      featureLayer.on("error", featureLayerError);
      featureLayer.on("layeradd", featureLayerAdd);
      featureLayer.on("click", featureLayerClicked);

      //  map.featureLayer.on("ready", featureLayerReady);

      // set filters
      //  featureLayer.setFilter(featureLayerSetFilter);

      // get data
      //  featureLayer.setGeoJSON(geoJson);

      // load data
      if (mapUseLiveData) {
        //featureLayer.loadURL("https://www.mapbox.com/mapbox.js/assets/data/eastcoast_cities.geojson")
        $.getJSON("https://www.mapbox.com/mapbox.js/assets/data/eastcoast_cities.geojson", loadComplete);
      }
      else {
        featureLayer.setGeoJSON(geoJson);
        map.fitBounds(featureLayer.getBounds());
      }
    }

    function mapReady() {
      console.log("map ready...");

      getCurrentLocation();
    }

    // Once we've got a position, zoom and center the map
    // on it, and add a single marker.
    function mapLocationFound(e) {
      map.fitBounds(e.bounds);

      console.log("map location found...");

      currentLocationMarker = L.marker(new L.LatLng(e.latlng.lat, e.latlng.lng), {
        icon: L.mapbox.marker.icon({
          "marker-size": "large",
          "marker-color": "1087bf" // "#ff8888",
          //        "marker-symbol": "star"
        }),
        draggable: false
      });

      // Create custom popup content
      var popupContent =
        '<div>' +
        '<h2>Current Location</h2>' +
        '</div>';

      currentLocationMarker.bindPopup(popupContent).addTo(map);

      //  map.setView(e.latlng);
      //  map.panTo(currentLocationMarker.getLatLong());

      initFeatureLayer();

      // Get Static Image
      getStaticMap();
    }

    function loadComplete(result, status) {
      if (status !== "success") {
        console.log("Request failed");
        return;
      }

      var liveMapData = result;
      featureLayer.setJson(liveMapData);
    }

    // If the user chooses not to allow their location
    // to be shared, display an error message.
    function mapLocationError(e) {
      console.log("map location not found...");
    }

    function featureLayerReady(e) {
      console.log("feature layer ready...");
      // featureLayer.getBounds() returns the corners of the furthest-out markers,
      // and map.fitBounds() makes sure that the map contains these.
      map.fitBounds(featureLayer.getBounds());

      // event handlers
      featureLayer.eachLayer(eachFeatureLayer);
    }

    function featureLayerError(e) {
      console.log("feature layer error...");
    }

    function featureLayerClicked(e) {
      console.log("feature layer clicked...");
      map.panTo(e.layer.getLatLng());
    }

    function calculateDistanceMiles(layer1, layer2) {
      var metersToMiles = 0.000621371192;

      var distanceMiles = (metersToMiles * layer1.getLatLng().distanceTo(layer2.getLatLng())).toFixed(1);

      return distanceMiles;
    }

    function featureLayerAdd(e) {
      console.log("feature layer add...");
      var marker = e.layer;
      var feature = marker.feature;

      var distance = calculateDistanceMiles(currentLocationMarker, marker);

      var popupContent = '<div>' +
        '<h2>' + feature.properties.title + '</h2>' +
        '<p>' + feature.properties.description + '</p>' +
        '<p>' + distance + ' miles' + '</p>' +
        '</div>';

      marker.bindPopup(popupContent, {
        closeButton: false
      });
    }

    function eachFeatureLayer(marker) {
      console.log("each feature layer...");
    }

    function featureLayerSetFilter(feature) {
      // If this symbol is in the list, return true. if not, return false.
      // The 'in' operator in javascript does exactly that: given a string
      // or number, it says if that is in a object.
      // 2 in { 2: true } // true
      // 2 in { } // false
      return (feature.properties["marker-symbol"] in enabled);
    }

    function featureLayerSearch(lat, lng) {
      var found = false;

      var i;
      for (i = 0; i < featureLayer.length; i++) {
        found = (featureLayer[i].gecometry.coordinates.latlng[0] == lat && featureLayer.geometry.coordinates.latlng[1] == lng);
      }
    }

    function getStaticMap() {
      var baseUrl = "https://api.mapbox.com/v4/mapbox.outdoors/";

      // Calculate a bounding box in west, south, east, north order.
      var bounds = geojsonExtent(geoJson);

      // The size of the desired map.
      var size = [200, 200];

      // Calculate a zoom level and centerpoint for this map.
      var vp = geoViewport.viewport(bounds, size);

      var requestUrl = baseUrl +
        //    pins.join(',') + '/' +
        vp.center.join(',') + ',' +
        vp.zoom + '/' +
        size.join('x') + '.png' +
        '?access_token=' + L.mapbox.accessToken;

      // quick and dirty
      $(".staticMap").attr("src", requestUrl);
    }

    var geoJson = [
      {
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [-78.8792008, 42.9779967]
        },
        "properties": {
          "title": "Coffee Shop",
          "description": "",
          "marker-color": "#be9a6b",
          "marker-size": "large",
          "marker-symbol": "cafe"
        }
      },
      {
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [-78.88758, 42.9787659]
        },
        "properties": {
          "title": "Sports Bar",
          "description": "",
          "marker-color": "#fc4353",
          "marker-size": "large",
          "marker-symbol": "beer"
        }
      },
      {
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [-78.8848325, 42.9814373]
        },
        "properties": {
          "title": "Restaurant",
          "description": "",
          "marker-color": "#7ec9b1",
          "marker-size": "large",
          "marker-symbol": "restaurant"
        }
      }
    ];

  </script>
</body>

</html>