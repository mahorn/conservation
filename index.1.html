<!doctype html>

<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Module 03 Turf.js</title>
    <link href='https://api.mapbox.com/mapbox.js/v3.1.1/mapbox.css' rel='stylesheet' />

    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
        }
        #map {
            position: absolute;
            width: 100%;
            top: 0;
            bottom: 0;
        }
    </style>

</head>

<body>
    <div id="map"></div>

    <script src='https://api.mapbox.com/mapbox.js/v3.1.1/mapbox.js'></script>
    <script src="https://d3js.org/d3-fetch.v1.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>

    <script>
        var map = L.map('map', {
            zoomSnap: .1,
            center: [40.33077, -99.5182],
            zoom: 2.4
        });
        // mapbox access token
        var accessToken = 'pk.eyJ1IjoibWFob3JuIiwiYSI6ImNpbnV0enJ4ZTEyNG91YW0zNGF6bTlva2wifQ.7jRtxQoaV2PHlRD7fu6U-g';
        // add mapbox tile layers using access token
        L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=' + accessToken, {
            attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
            maxZoom: 18,
            id: 'mapbox.light',
            accessToken: accessToken
        }).addTo(map);
        // create a geocoder control object with options
        var geoCoderControl = L.mapbox.geocoderControl('mapbox.places', {
            accessToken: accessToken,
            keepOpen: true,
            autocomplete: true,
            position: 'topright'
        });
        // add the geocoder to the map
        map.addControl(geoCoderControl)
        // use d3-fetch to request the topojson
        d3.json('data/merge_files_sim.json')
            .then(function (data) {
                // send data out of callback to a new function
                drawMap(data);
            });
        function drawMap(data) {
            // convert the TopoJSON to GeoJSON
            var geojson = topojson.feature(data, data.objects.merge_files_sim);
            // add to our map
            var counties = L.geoJson(geojson, {
                style: function (feature, layer) {
                    return {
                        color: 'white',
                        fillColor: '#448ee4',
                        fillOpacity: '.7',
                        weight: 1
                    }
                }
            }).addTo(map);
            // listen for a selection and then invoke the callback function
            geoCoderControl.on('select', function (result) {
                // add a maker on the map
                var searchResult = L.geoJson(result.feature).addTo(map);
                // add and open tooltip
                searchResult.bindTooltip(result.feature.name).openTooltip();
                // loop through the county layers
                counties.eachLayer(function (layer) {
                    // convert Leaflet layer to geojson with Leaflet toGeoJSON() method
                    var polyFeature = layer.toGeoJSON();
                    // console.log(polyFeature);
                    // if the result's feature is inside the polygon
                    if (turf.booleanPointInPolygon(result.feature, polyFeature)) {
                        // adjust the map pan/zoom to the county layer bounds
                        map.flyToBounds(layer.getBounds(), {
                            padding: [20, 20]
                        });
                        // when the map is zooming on the flyTo
                        map.on('zoomend', function () {
                            layer.setStyle({
                                color: '#f0dc00',
                                fill: false,
                                weight: '3'
                            }).bringToFront();
                            // create a callback function into another function w/ layer and the feature from the search result
                            findDistanceToCentroid(layer, result.feature);
                        });
                    }
                });
            });
        } // end drawMap
        // declare findDistanceToCentroid function with 2 parameters(rename layer and result.feature)
        function findDistanceToCentroid(countyPolygon, searchedFeature) {
            // convert Leaflet county back to GeoJSON
            var convertCounty = countyPolygon.toGeoJSON();
            // use turf.centerOfMass to create a point feature at the centroid
            var center = turf.centerOfMass(convertCounty);
            // create a new marker at the center of the county
            var centerResult = L.geoJson(center).addTo(map);
            // use Turf to determine the distance in miles between the center and point 
            var options = { units: 'miles' };
            var distancePoint = turf.distance(searchedFeature, center, options);
            // bind the distance info to the centroid marker and open the tooltip reducing the decimals to 2
            centroResult.bindTooltip('County Centroide: ' + distancePoint.toFixed(2) + ' miles from the search location').openTooltip();
        }
    </script>
</body>

</html>